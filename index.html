<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>MQTT Environment Dashboard</title>

  <!--Style Sheets-->
  <link href="./css/dashboardmqtt.css" rel="stylesheet" type="text/css"/>
  <link href="./weather-icons-master/css/weather-icons.css" rel="stylesheet" type="text/css"/>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

  <script type="text/javascript">
    // helper
    function changeBodyBg(color) { document.body.style.background = color; }

    // MQTT variables
    var mqtt = null;
    var reconnectTimeout = 2000;
    var host = "";
    var port = 0;
    var clientID = "clientID" + Math.floor(Math.random() * 10000);

    // choose host/port depending on protocol
    if (location.protocol !== 'https:') {
      host = "mqtt.cetools.org";
      port = 8080;
    } else {
      host = "mqtt.cetools.org";
      port = 8081;
    }

    function onConnect() {
      console.log("MQTT connected to " + host + ":" + port + " as " + clientID);
      $("#mqttconnection").html("mqtt: connected");

      // subscribe to relevant topics
      try { mqtt.subscribe("personal/ucfnaps/#"); }
      catch (e) { console.warn('subscribe error', e); }

      mqtt.onMessageArrived = decode;
    }

    function onFailure(message) {
      console.log("Connection attempt to host " + host + " failed", message);
      $("#mqttconnection").html("mqtt: disconnected");
      setTimeout(MQTTconnect, reconnectTimeout);
    }

    function onConnectionLost(responseObject) {
      console.log("Connection lost", responseObject);
      $("#mqttconnection").html("mqtt: disconnected");
      if (responseObject && responseObject.errorCode !== 0) {
        setTimeout(MQTTconnect, reconnectTimeout);
      }
    }

    function MQTTconnect() {
      console.log("Connecting to " + host + " " + port + " ...");
      mqtt = new Paho.MQTT.Client(host, Number(port), clientID);

      mqtt.onConnectionLost = onConnectionLost;
      mqtt.onMessageArrived = decode;

      var options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: onFailure,
        useSSL: (location.protocol === 'https:')
      };

      try { mqtt.connect(options); }
      catch (e) { console.error('MQTT connect error:', e); setTimeout(MQTTconnect, reconnectTimeout); }
    }

    function decode(msg) {
      var t = msg.destinationName;
      var p = msg.payloadString;
      console.log('MSG', t, p);

      var directMap = {
        "personal/ucfnaps/downhamweather/tempmax": "#tempmax",
        "personal/ucfnaps/downhamweather/tempmin": "#tempmin",
        "personal/ucfnaps/downhamweather/pressuremax": "#baromax",
        "personal/ucfnaps/downhamweather/pressuremin": "#baromin",
        "personal/ucfnaps/eink/met/headline": "#currentcond",
        "personal/ucfnaps/airquality/davisaqi": "#AQI",
        "personal/ucfnaps/airquality/davisquality": "#aqiquality",
        "personal/ucfnaps/airquality/davispm25": "#pmtwo",
        "personal/ucfnaps/airquality/davispm10": "#pmten",
        "personal/ucfnaps/airquality/davistrend": "#pmtrend",
        "personal/ucfnaps/environ/marham": "#marham",
        "personal/ucfnaps/environ/ely": "#ely",
        "personal/ucfnaps/environ/denver": "#denver",
        "personal/ucfnaps/downhamweather/temptrend": "#temptrend",
        "personal/ucfnaps/downhamweather/windmax": "#windmaxgust"
      };

      if (directMap[t]) { $(directMap[t]).html(p); return; }

      if (t === "personal/ucfnaps/downhamweather/barotrend") {
        var pressurehour = p.replace('mbar', '').trim();
        $("#pbarohour").html(pressurehour);
        var ph = parseFloat(pressurehour);
        if (isNaN(ph)) { $("#pressuretrend").html("unknown"); }
        else if (ph >= -0.7 && ph <= 0.7) { $("#pressuretrend").html("steady"); }
        else if (ph > 0.7) { $("#pressuretrend").html("rising"); }
        else { $("#pressuretrend").html("falling"); }
        return;
      }

      if (t === "personal/ucfnaps/downhamweather/loop") {
        try {
          var data = JSON.parse(p);

          var wind = parseFloat(data['windSpeed_mph']);
          if (!isNaN(wind)) { $("#wind").html(wind); }

          var windspeed10 = parseFloat(data['windSpeed10_mps']);
          if (!isNaN(windspeed10)) { $("#windspeed10").html((windspeed10 * 2.23694).toFixed(1)); }

          // Beaufort-style ranges
          if (!isNaN(wind)) {
            if (wind >= 73) $("#beaufort").html("hurricane");
            else if (wind >= 64) $("#beaufort").html("violent storm");
            else if (wind >= 56) $("#beaufort").html("storm");
            else if (wind >= 48) $("#beaufort").html("strong gale");
            else if (wind >= 41) $("#beaufort").html("gale");
            else if (wind >= 34) $("#beaufort").html("near gale");
            else if (wind >= 28) $("#beaufort").html("strong breeze");
            else if (wind >= 22) $("#beaufort").html("stiff breeze");
            else if (wind >= 17) $("#beaufort").html("moderate breeze");
            else if (wind >= 11) $("#beaufort").html("gentle breeze");
            else if (wind >= 7) $("#beaufort").html("light breeze");
            else if (wind >= 4) $("#beaufort").html("slight breeze");
            else $("#beaufort").html("calm");
          }

          var winddir = parseFloat(data['windDir']);
          if (!isNaN(winddir)) {
            var dir = 'N';
            if (winddir >= 348.75 || winddir < 11.25) dir = 'N';
            else if (winddir < 33.75) dir = 'NNE';
            else if (winddir < 56.25) dir = 'NE';
            else if (winddir < 78.75) dir = 'ENE';
            else if (winddir < 101.25) dir = 'E';
            else if (winddir < 123.75) dir = 'ESE';
            else if (winddir < 146.25) dir = 'SE';
            else if (winddir < 168.75) dir = 'SSE';
            else if (winddir < 191.25) dir = 'S';
            else if (winddir < 213.75) dir = 'SSW';
            else if (winddir < 236.25) dir = 'SW';
            else if (winddir < 258.75) dir = 'WSW';
            else if (winddir < 281.25) dir = 'W';
            else if (winddir < 303.75) dir = 'WNW';
            else if (winddir < 326.25) dir = 'NW';
            else dir = 'NNW';
            $("#winddir").html(dir);
          }

          if (data['outTemp_C'] !== undefined) {
            $("#temp").html(data['outTemp_C']);
            var temp = parseFloat(data['outTemp_C']);
            if (!isNaN(temp)) {
              if (temp >= 25) changeBodyBg('#dc343b');
              else if (temp >= 20) changeBodyBg('#f2552c');
              else if (temp >= 15) changeBodyBg('#ff9926');
              else if (temp >= 10) changeBodyBg('#f3c12c');
              else if (temp >= 5) changeBodyBg('#45B8AC');
              else if (temp >= 0) changeBodyBg('#009cdc');
              else changeBodyBg('#7CA6DE');
            }
          }

          if (data['appTemp_C'] !== undefined) { var apptemp = parseFloat(data['appTemp_C']); if (!isNaN(apptemp)) $("#apptemp").html(apptemp.toFixed(1)); }
          if (data['dayRain_mm'] !== undefined) $("#rain").html(data['dayRain_mm']);
          if (data['rainRate_mm_per_hour'] !== undefined) { var rr = parseFloat(data['rainRate_mm_per_hour']); if (!isNaN(rr)) $("#rainrate").html(rr.toFixed(1)); }
          if (data['barometer_mbar'] !== undefined) $("#baro").html(data['barometer_mbar']);
          if (data['radiation_Wpm2'] !== undefined) $("#solar").html(data['radiation_Wpm2']);
          if (data['outHumidity'] !== undefined) $("#humidity").html(data['outHumidity']);
          if (data['UV'] !== undefined) $("#uv").html(data['UV']);
          if (data['cloudbase_meter'] !== undefined) $("#cloudheight").html(data['cloudbase_meter']);
          if (data['dewpoint_C'] !== undefined) { var dp = parseFloat(data['dewpoint_C']); if (!isNaN(dp)) $("#dewpoint").html(dp.toFixed(1)); }

        } catch (e) {
          console.warn("Failed to parse JSON payload for loop topic", e);
        }
      }
    }

    $(function() { MQTTconnect(); });
  </script>
</head>
<body class="top">

<div id="dashboard">

<div id="top">
  <div id="left"><span id="currentcond"></span></div>
  <div id="mqttconnection" style="position:absolute;right:8px;top:8px;color:white">mqtt: connecting</div>
</div>

<!-- Full dashboard HTML preserved exactly as before -->

<div class="data">
  <div class="dataValue" style="font-size : 50px"><i class="wi wi-thermometer"></i></div>
</div>

<div class="data">
  <div class="dataValue"> <span id="temp" lastobs="loading&deg;C">loading</span></div>
  <div class="title">temp</div>
</div>

<div id="TempTrend" class="data">
  <div class="dataValue"> <span id="temptrend" lastobs="loading&deg;C">loading</span></div>
  <div class="title">trend / hr</div>
</div>

<div id="TempMax" class="data">
  <div class="dataValue"> <span id="tempmax" lastobs="loading&deg;C">loading</span></div>
  <div class="title">max</div>
</div>

<div id="TempMin" class="data">
  <div class="dataValue"> <span id="tempmin" lastobs="loading&deg;C">loading</span></div>
  <div class="title">min</div>
</div>

<div id="14" class="data">
  <div class="dataValue"> <span id="apptemp" lastobs="loading&deg;C">loading</span></div>
  <div class="title">feels like</div>
</div>

<div><hr size="1" color="white" ></div>

<div class="data">
  <div class="dataValue" style="font-size : 50px" ><i class="wi wi-small-craft-advisory"></i></div>
</div>

<div id="Wind" class="data">
  <div class="dataValue"> <span id="wind" lastobs="loading&deg;C">loading</span></div>
  <div class="title">wind</div>
</div>

<div id="WindAverage" class="data">
  <div class="dataValue"> <span id="windspeed10" lastobs="loading&deg;C">loading</span></div>
  <div class="title">av / ten min</div>
</div>

<div id="MaxGust" class="data">
  <div class="dataValue"> <span id="windmaxgust" lastobs="loading&deg;C">loading</span></div>
  <div class="title">max</div>
</div>

<div id="Beaufort" class="data">
  <div class="dataText"> <span id="beaufort" lastobs="loading&deg;C">loading</span></div>
  <div class="title">beaufort</div>
</div>

<div id="WindDirection" class="data">
  <div class="dataText"> <span id="winddir" lastobs="loading&deg;C">loading</span></div>
  <div class="title">direction</div>
</div>

<div><hr size="1" color="white" ></div>

<div class="data">
  <div class="dataValue" style="font-size: 50px; text-align: center;"><i class="wi wi-umbrella"></i></div>
</div>

<div id="Rain" class="data">
  <div class="dataValue"> <span id="rain" lastobs="loading&deg;C">loading</span></div>
  <div class="title">Vantage Pro</div>
</div>

<div id="vp2data" class="data">
  <div class="dataValue"> <span id="rainrate" lastobs="loading&deg;C">loading</span></div>
  <div class="title">Rate / HR&nbsp; &nbsp;</div>
</div>

<div id="marhamdata" class="data">
  <div class="dataValue"> <span id="marham" lastobs="loading&deg;C">loading</span></div>
  <div class="title">marham</div>
</div>

<div id="Denver" class="data">
  <div class="dataValue"> <span id="denver" lastobs="loading&deg;C">loading</span></div>
  <div class="title">denver</div>
</div>

<div id="Ely" class="data">
  <div class="dataValue"> <span id="ely" lastobs="loading&deg;C">loading</span></div>
  <div class="title">ely</div>
</div>

<div><hr size="1" color="white" ></div>

<div class="data">
  <div class="dataValue" style="font-size: 50px; text-align: center;"><i class="wi wi-dust"></i></div>
</div>

<div id="aqiindex" class="data">
  <div class="dataValue"> <span id="AQI" lastobs="loading&deg;C">loading</span></div>
  <div class="title">AQI</div>
</div>

<div id="q" class="data">
  <div class="dataValue"> <span id="aqiquality" lastobs="loading&deg;C">loading</span></div>
  <div class="title">AQI Rating&nbsp; &nbsp;</div>
</div>

<div id="pm25tag" class="data">
  <div class="dataValue"> <span id="pmtwo" lastobs="loading&deg;C">loading</span></div>
  <div class="title">pm two.five</div>
</div>

<div id="pmtest" class="data">
  <div class="dataValue"> <span id="pmten" lastobs="loading&deg;C">loading</span></div>
  <div class="title">PM ten</div>
</div>

<div id="tag" class="data">
  <div class="dataText"> <span id="pmtrend" lastobs="loading&deg;C">loading</span></div>
  <div class="title">quality&nbsp;</div>
</div>

<div><hr size="1" color="white" ></div>

<div class="data">
  <div class="dataValue" style="font-size : 50px"><i class="wi wi-barometer"></i></div>
</div>

<div id="Pressure" class="data">
  <div class="dataValue"> <span id="baro" lastobs="loading&deg;C">loading</span></div>
  <div class="title">pressure</div>
</div>

<div id="Pressure_Hour" class="data">
  <div class="dataValue"> <span id="pbarohour" lastobs="loading&deg;C">loading</span></div>
  <div class="title">trend / hr</div>
</div>

<div id="PressureMax" class="data">
  <div class="dataValue"> <span id="baromax" lastobs="loading&deg;C">loading</span></div>
  <div class="title">max</div>
</div>

<div id="PressureMin" class="data">
  <div class="dataValue"> <span id="baromin" lastobs="loading&deg;C">loading</span></div>
  <div class="title">min</div>
</div>

<div class="data">
  <div class="dataText"> <span id="pressuretrend" lastobs="loading&deg;C">loading</span></div>
  <div class="title">state</div>
</div>

<div><hr size="1" color="white" ></div>

<div class="data">
  <div class="dataValue" style="font-size : 50px"><i class="wi wi-day-sunny"></i></div>
</div>

<div id="Solar" class="data">
  <div class="dataValue"> <span id="solar" lastobs="loading&deg;C">loading</span></div>
  <div class="title">solar</div>
</div>

<div id="Solarpct" class="data">
  <div class="dataValue"> <span id="uv" lastobs="loading&deg;C">loading</span></div>
  <div class="title">UV&nbsp;</div>
</div>

<div id="Sunshine" class="data">
  <div class="dataValue"> <span id="dewpoint" lastobs="loading&deg;C">loading</span></div>
  <div class="title">dew point</div>
</div>

<div id="Humidity" class="data">
  <div class="dataValue"> <span id="humidity" lastobs="loading&deg;C">loading</span></div>
  <div class="title">humidity %</div>
</div>

<div id="CloudBase" class="data">
  <div class="dataValue"> <span id="cloudheight" lastobs="loading&deg;C">loading</span></div>
  <div class="title">cloud base m</div>
</div>

</div>

</body>
</html>
